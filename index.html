<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SafuFlix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { background: #141414; color: #fff; font-family: 'Roboto', Arial, sans-serif; margin: 0; }
    .header { background: #181818; padding: 20px 0 10px 0; text-align: center; }
    .header h1 { color: #e50914; font-size: 2.5em; margin: 0; letter-spacing: 2px; }
    .search-bar { text-align: center; margin: 20px 0; }
    .search-bar input, .search-bar select {
      padding: 10px; border-radius: 5px; border: none; font-size: 1em; margin: 0 5px;
    }
    .categories { text-align: center; margin-bottom: 20px; }
    .categories button {
      background: #333; color: #fff; border: none; border-radius: 20px; padding: 8px 18px; margin: 0 5px 10px 5px;
      cursor: pointer; font-size: 1em; transition: background 0.2s;
    }
    .categories button.active, .categories button:hover { background: #e50914; }
    .grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; }
    .card {
      background: #222; border-radius: 12px; width: 260px; box-shadow: 0 2px 8px #0008;
      overflow: hidden; display: flex; flex-direction: column; margin-bottom: 30px;
      transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.04); }
    .poster { width: 100%; height: 370px; object-fit: cover; background: #111; }
    .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
    .title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
    .meta { color: #ffb300; font-size: 0.95em; margin-bottom: 8px; }
    .plot { font-size: 0.98em; color: #ccc; margin-bottom: 10px; }
    .actions { margin-top: auto; }
    .actions button, .actions a {
      background: #e50914; color: #fff; border: none; border-radius: 5px; padding: 7px 14px;
      margin-right: 7px; margin-bottom: 7px; cursor: pointer; font-size: 0.98em; text-decoration: none; display: inline-block;
    }
    .actions button:hover, .actions a:hover { background: #b0060f; }
    .episodes { margin-top: 10px; }
    .episode-title { font-weight: bold; color: #fff; }
    .episode-list { list-style: none; padding: 0; margin: 0; }
    .episode-list li { margin-bottom: 10px; background: #181818; border-radius: 6px; padding: 8px; }
    @media (max-width: 700px) {
      .grid { flex-direction: column; align-items: center; }
      .card { width: 95vw; }
      .poster { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>SafuFlix</h1>
  </div>
  <div class="search-bar">
    <input type="text" id="searchBox" placeholder="Search movie, series or episode...">
    <select id="genreFilter">
      <option value="">All Genres</option>
    </select>
  </div>
  <div class="categories" id="categories"></div>
  <div class="grid" id="movieGrid"></div>
  <script>
    let movies = JSON.parse(localStorage.getItem('movies') || '[]');
    let genres = [];
    // Collect all genres
    movies.forEach(m => {
      if (m.meta && m.meta.genre) {
        m.meta.genre.split(',').forEach(g => {
          g = g.trim();
          if (g && !genres.includes(g)) genres.push(g);
        });
      }
    });
    // Populate genre filter
    const genreFilter = document.getElementById('genreFilter');
    genres.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g;
      opt.textContent = g;
      genreFilter.appendChild(opt);
    });

    function renderCategories() {
      const catDiv = document.getElementById('categories');
      catDiv.innerHTML = '';
      genres.forEach(g => {
        catDiv.innerHTML += `<button onclick="filterByGenre('${g}')">${g}</button>`;
      });
    }
    renderCategories();

    function filterByGenre(genre) {
      document.getElementById('genreFilter').value = genre;
      renderGrid(document.getElementById('searchBox').value.trim().toLowerCase(), genre);
    }

    function renderGrid(filter = "", genre = "") {
      const grid = document.getElementById('movieGrid');
      grid.innerHTML = '';
      let filtered = movies.filter(m => m.visible);
      if (genre) {
        filtered = filtered.filter(m => m.meta && m.meta.genre && m.meta.genre.includes(genre));
      }
      filtered.forEach(m => {
        // Search filter
        let match = false;
        if (filter === "") match = true;
        else if (m.title.toLowerCase().includes(filter)) match = true;
        // For series, check episode title
        if (m.type === 'series' && m.episodes) {
          if (m.episodes.some(ep => ep.epTitle.toLowerCase().includes(filter))) match = true;
        }
        if (!match) return;

        let metaHtml = '';
        if (m.meta) {
          metaHtml = `
            ${m.meta.poster ? `<img src="${m.meta.poster}" class="poster">` : `<div class="poster"></div>`}
            <div class="card-content">
              <div class="title">${m.title}</div>
              <div class="meta">${m.meta.year ? m.meta.year + ' | ' : ''}${m.meta.genre ? m.meta.genre + ' | ' : ''}${m.meta.imdb ? 'IMDB: ' + m.meta.imdb : ''}</div>
              <div class="plot">${m.meta.plot || ''}</div>
          `;
        } else {
          metaHtml = `
            <div class="poster"></div>
            <div class="card-content">
              <div class="title">${m.title}</div>
          `;
        }

        let actionsHtml = '';
        if (m.type === 'movie') {
          actionsHtml = `
            <div class="actions">
              <a href="${m.url}" target="_blank">Play</a>
              <a href="${m.url}" download>Download</a>
              <button onclick="copyLink('${m.url}')">Copy Link</button>
              <a href="intent://${m.url.replace(/^https?:\/\//, '')}#Intent;type=video/mp4;end">Play with VLC</a>
            </div>
          `;
        } else if (m.type === 'series') {
          actionsHtml = `
            <div class="actions">
              <a href="${m.url}" target="_blank">Play Trailer</a>
            </div>
            <div class="episodes">
              <div class="episode-title">Episodes:</div>
              <ul class="episode-list">
                ${m.episodes.map((ep, epi) => `
                  <li>
                    <div><b>${ep.epTitle}</b></div>
                    <div class="actions">
                      <a href="${ep.epUrl}" target="_blank">Play</a>
                      <a href="${ep.epUrl}" download>Download</a>
                      <button onclick="copyLink('${ep.epUrl}')">Copy Link</button>
                      <a href="intent://${ep.epUrl.replace(/^https?:\/\//, '')}#Intent;type=video/mp4;end">Play with VLC</a>
                    </div>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }

        grid.innerHTML += `
          <div class="card">
            ${metaHtml}
            ${actionsHtml}
            </div>
          </div>
        `;
      });
    }

    function copyLink(url) {
      const tempInput = document.createElement('input');
      tempInput.value = url;
      document.body.appendChild(tempInput);
      tempInput.select();
      tempInput.setSelectionRange(0, 99999);
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      alert('Link copied!');
    }

    document.getElementById('searchBox').addEventListener('input', function() {
      renderGrid(this.value.trim().toLowerCase(), genreFilter.value);
    });
    genreFilter.addEventListener('change', function() {
      renderGrid(document.getElementById('searchBox').value.trim().toLowerCase(), this.value);
    });

    renderGrid();
  </script>
</body>
</html>
